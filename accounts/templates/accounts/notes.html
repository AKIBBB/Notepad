{% extends 'accounts/base.html' %}
{% block title %}My Notes{% endblock %}

{% block content %}
<div class="row justify-content-center">
  <!-- Note Input Form -->
  <div class="col-md-6">
    <div class="card shadow-sm mb-4">
      <div class="card-header bg-primary text-white">
        <h5 class="mb-0 text-center">Take a Note</h5>
      </div>
      <div class="card-body">
        <form method="post" enctype="multipart/form-data" id="noteForm">
          {% csrf_token %}

          <!-- Rich Text Editor (Resizable container) -->
          <div class="mb-3" style="resize: vertical; overflow: hidden; min-height: 150px;">
            <label class="form-label">Write your note</label>
            <div id="editor" style="height: 150px; min-height: 150px;"></div>
            <input type="hidden" name="text" id="textInput">
          </div>

          <!-- Drawing Tools -->
          <div class="mb-2 d-flex gap-2 align-items-center flex-wrap">
            <label class="mb-0">Tool:</label>
            <select id="toolSelect" class="form-select form-select-sm w-auto">
              <option value="pen" selected>Pen</option>
              <option value="rectangle">Rectangle</option>
              <option value="triangle">Triangle</option>
              <option value="eraser">Eraser</option>
            </select>

            <label class="mb-0">Color:</label>
            <input type="color" id="colorPicker" value="#000000">

            <label class="mb-0">Line Width:</label>
            <input type="number" id="lineWidth" value="2" min="1" max="10" class="form-control form-control-sm w-auto">

            <button type="button" id="clearCanvas" class="btn btn-sm btn-danger">Clear</button>
          </div>

          <!-- Drawing Canvas (Resizable container) -->
          <div class="mb-3" style="resize: both; overflow: hidden; border:1px solid #ccc; display:inline-block; width:400px; height:300px;">
            <canvas id="canvas" width="400" height="300" class="border rounded w-100 h-100"></canvas>
            <input type="hidden" name="drawing" id="drawingInput">
          </div>

          <button type="submit" class="btn btn-primary w-100">Save Note</button>
        </form>
      </div>
    </div>
  </div>

  <!-- Saved Notes Section -->
  <div class="col-md-6">
    <h4 class="mb-3 text-center">Your Notes</h4>
    {% for note in notes %}
    <div class="card mb-3 shadow-sm">
      <div class="card-body">
        <div class="mb-2">
          {% if note.text|striptags|length > 0 %}
            {{ note.text|safe }}
          {% else %}
            (No text)
          {% endif %}
        </div>

        {% if note.drawing %}
          <img src="{{ note.drawing.url }}" class="img-fluid rounded mb-2" alt="drawing">
        {% else %}
          <div style="width:100%;height:150px;background:#f5f5f5;text-align:center;line-height:150px;color:#999;">
            (No drawing)
          </div>
        {% endif %}

        <small class="text-muted d-block mb-2">{{ note.created_at|date:"M d, Y H:i" }}</small>
        <div class="d-flex justify-content-end gap-2">
          <a href="{% url 'edit_note' note.id %}" class="btn btn-sm btn-outline-primary">Edit</a>
          <a href="{% url 'delete_note' note.id %}" class="btn btn-sm btn-outline-danger">Delete</a>
          <a href="{% url 'download_note' note.id %}" class="btn btn-sm btn-success">Download</a>
        </div>
      </div>
    </div>
    {% empty %}
    <p class="text-center text-muted">No notes yet.</p>
    {% endfor %}
  </div>
</div>

<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const quill = new Quill('#editor', { 
        theme: 'snow',
        modules: { toolbar: [
            [{ 'header': [1,2,3,false] }],
            ['bold','italic','underline','strike'],
            [{ 'color': [] }, { 'background': [] }],
            [{ 'align': [] }],
            ['link','image'],
            ['clean']
        ]}
    });

    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    ctx.fillStyle = 'white';
    ctx.fillRect(0,0,canvas.width,canvas.height);

    let drawing=false, currentShape=null, shapes=[], startX=0, startY=0;

    function drawAll() {
        ctx.fillStyle='white';
        ctx.fillRect(0,0,canvas.width,canvas.height);
        shapes.forEach(shape=>{
            ctx.strokeStyle=shape.color;
            ctx.lineWidth=shape.lineWidth;
            ctx.beginPath();
            if(shape.type==='rectangle') ctx.strokeRect(shape.x,shape.y,shape.w,shape.h);
            else if(shape.type==='triangle') {
                ctx.moveTo(shape.x, shape.y - shape.size/2);
                ctx.lineTo(shape.x - shape.size/2, shape.y + shape.size/2);
                ctx.lineTo(shape.x + shape.size/2, shape.y + shape.size/2);
                ctx.closePath();
                ctx.stroke();
            } else if(shape.type==='pen') {
                ctx.lineCap='round';
                for(let i=1;i<shape.points.length;i++){
                    ctx.beginPath();
                    ctx.moveTo(shape.points[i-1].x, shape.points[i-1].y);
                    ctx.lineTo(shape.points[i].x, shape.points[i].y);
                    ctx.stroke();
                }
            }
        });
    }

    canvas.addEventListener('mousedown', e=>{
        startX=e.offsetX; startY=e.offsetY;
        const tool = document.getElementById('toolSelect').value;
        if(tool==='pen' || tool==='eraser'){
            drawing=true;
            currentShape={type:'pen', color: tool==='eraser'?'white':'#000000', lineWidth:2, points:[{x:startX,y:startY}]};
        } else if(tool==='rectangle'){
            currentShape={type:'rectangle', x:50, y:50, w:150, h:100, color:'#000000', lineWidth:2};
            shapes.push(currentShape);
        } else if(tool==='triangle'){
            currentShape={type:'triangle', x:200, y:150, size:100, color:'#000000', lineWidth:2};
            shapes.push(currentShape);
        }
    });

    canvas.addEventListener('mousemove', e=>{
        if(!drawing) return;
        currentShape.points.push({x:e.offsetX,y:e.offsetY});
        drawAll();
    });

    canvas.addEventListener('mouseup', e=>{
        drawing=false;
        shapes.push(currentShape);
        currentShape=null;
        drawAll();
    });

    document.getElementById('clearCanvas').addEventListener('click', ()=>{ shapes=[]; drawAll(); });

    // On submit, save Quill text + canvas as base64
    document.getElementById('noteForm').addEventListener('submit', function(e){
        document.getElementById('textInput').value = quill.root.innerHTML;
        const hiddenInput = document.getElementById('drawingInput');
        hiddenInput.value = canvas.toDataURL('image/png');
    });

    // Make canvas container resizable without scrollbars
    const canvasContainer = canvas.parentElement;
    const resizeObserver = new ResizeObserver(()=>{
        const tempImage = new Image();
        tempImage.src = canvas.toDataURL();
        tempImage.onload = function() {
            canvas.width = canvasContainer.clientWidth;
            canvas.height = canvasContainer.clientHeight;
            ctx.drawImage(tempImage, 0, 0, canvas.width, canvas.height);
        };
    });
    resizeObserver.observe(canvasContainer);
});
</script>
{% endblock %}
